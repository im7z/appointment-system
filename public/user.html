<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Portal</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .filters { display:grid; grid-template-columns: repeat(3, minmax(220px,1fr)); gap:8px; margin:.5rem 0; }
    @media (max-width:720px){ .filters{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header class="topbar">
    <h1>Patient Portal</h1>
    <nav>
      <a href="admin.html">Go to Admin</a>
    </nav>
  </header>

  <!-- Search + Local Filters -->
  <section class="card">
    <h2>Search Available Slots</h2>
    <div class="filters">
      <input id="docSearch" placeholder="Doctor Name (optional)" />
      <label>From: <input id="fromDT" type="datetime-local" /></label>
      <label>To: <input id="toDT" type="datetime-local" /></label>
    </div>
    <button class="primary" onclick="searchSlots()">Fetch & Filter</button>
    <div id="stats" class="muted"></div>
    <div id="slotsWrap"></div>
  </section>

  <!-- Book appointment -->
  <section class="card">
    <h2>Book Appointment</h2>
    <div class="grid3">
      <input id="bookId" placeholder="Appointment ID" />
      <input id="userName" placeholder="Your Name" />
      <button onclick="book()">Confirm Booking</button>
    </div>
    <pre id="bookOut" class="codebox"></pre>
  </section>

  <!-- Loyalty points -->
  <section class="card">
    <h2>My Loyalty Points</h2>
    <div class="grid3">
      <input id="pointsUser" placeholder="Your Name" />
      <button onclick="loadPoints()">Show</button>
      <button class="ghost" onclick="clearPoints()">Clear</button>
    </div>
    <pre id="pointsOut" class="codebox"></pre>
  </section>

  <footer class="footer">
    <span>Patient • Behavior-Driven Scheduling Prototype</span>
  </footer>

  <script>
    const API = "http://localhost:3000";
    const fmt = s => { const d = new Date(s); return isNaN(d) ? s : d.toLocaleString(); };

    function table(rows) {
      if (!rows?.length) return "<p class='muted'>No slots match your filters.</p>";
      const trs = rows.map(r => `
        <tr>
          <td>${r._id}</td>
          <td>${r.doctorName}</td>
          <td>${fmt(r.date)}</td>
          <td><span class="badge ${r.status}">${r.status}</span></td>
          <td><button class="ghost" onclick="copyId('${r._id}')">Copy ID</button></td>
        </tr>
      `).join("");
      return `
        <div class="tablewrap">
          <table>
            <thead>
              <tr><th>ID</th><th>Doctor</th><th>Date/Time</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody>${trs}</tbody>
          </table>
        </div>
      `;
    }

    function copyId(id){ navigator.clipboard.writeText(id); alert("Copied ID: " + id); document.getElementById("bookId").value = id; }

    async function searchSlots() {
      const doctorName = document.getElementById("docSearch").value.trim();
      const url = doctorName ? `${API}/appointments/available?doctorName=${encodeURIComponent(doctorName)}`
                             : `${API}/appointments/available`;
      const res = await fetch(url);
      const data = await res.json();
      let slots = Array.isArray(data.slots) ? data.slots : [];

      // local time filter
      const fromVal = document.getElementById("fromDT").value;
      const toVal   = document.getElementById("toDT").value;
      const fromTS  = fromVal ? new Date(fromVal).getTime() : null;
      const toTS    = toVal   ? new Date(toVal).getTime()   : null;

      slots = slots.filter(s => {
        const t = new Date(s.date).getTime();
        if (isNaN(t)) return false;
        if (fromTS !== null && t < fromTS) return false;
        if (toTS !== null && t > toTS) return false;
        return true;
      }).sort((a,b) => new Date(a.date) - new Date(b.date));

      document.getElementById("slotsWrap").innerHTML = table(slots);
      document.getElementById("stats").textContent =
        `${slots.length} slot(s) shown` +
        (doctorName ? ` · doctor: "${doctorName}"` : "") +
        (fromVal ? ` · from: ${fromVal}` : "") +
        (toVal ? ` · to: ${toVal}` : "");
    }

    async function book() {
      const id = document.getElementById("bookId").value;
      const userName = document.getElementById("userName").value;
      const res = await fetch(`${API}/appointments/book/${id}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ userName })
      });
      document.getElementById("bookOut").textContent = JSON.stringify(await res.json(), null, 2);
    }

    async function loadPoints() {
      const userName = document.getElementById("pointsUser").value;
      const res = await fetch(`${API}/users/${encodeURIComponent(userName)}`);
      document.getElementById("pointsOut").textContent = JSON.stringify(await res.json(), null, 2);
    }
    function clearPoints(){ document.getElementById("pointsOut").textContent = ""; }
  </script>
</body>
</html>
